name: CD - Deploy to K8s

on:
  workflow_run:
    workflows: ["CD Build and Push"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Set context
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBECONFIG }}

    - name: Update image tags
      run: |
        sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/backend.yaml
        sed -i "s|latest|${{ github.sha }}|g" k8s/backend.yaml
        
        sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/celery-worker.yaml
        sed -i "s|latest|${{ github.sha }}|g" k8s/celery-worker.yaml
        
        sed -i "s|DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/frontend.yaml
        sed -i "s|latest|${{ github.sha }}|g" k8s/frontend.yaml

    - name: Deploy manifests
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/postgres.yaml
        kubectl apply -f k8s/redis.yaml
        kubectl apply -f k8s/minio.yaml
        kubectl apply -f k8s/gotenberg.yaml
        kubectl apply -f k8s/backend.yaml
        kubectl apply -f k8s/celery-worker.yaml
        kubectl apply -f k8s/frontend.yaml

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/backend-deployment
        kubectl rollout status deployment/frontend-deployment
